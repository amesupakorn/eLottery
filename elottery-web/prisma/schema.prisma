generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          Int         @id @default(autoincrement())
  email       String?     @unique @db.VarChar(255)
  full_name   String?     @db.VarChar(255)
  status      UserStatus  @default(ACTIVE)
  created_at  DateTime    @default(now())
  cognito_sub String?     @unique
  Wallet      Wallet?
  notify_opt  Boolean?    @default(false)
  @@map("users")
  ticketPurchases TicketPurchase[]
}

model Wallet {
  id         Int                  @id @default(autoincrement())
  user_id    Int                  @unique
  currency   String               @db.Char(3)
  balance    Decimal              @default(0) @db.Decimal(18, 2)
  created_at DateTime             @default(now())
  updated_at DateTime             @default(now())
  ledger     AccountTransaction[]
  user       User                 @relation(fields: [user_id], references: [id])

  @@map("wallets")
  ticketPurchases TicketPurchase[]
}

model AccountTransaction {
  id            Int       @id @default(autoincrement())
  wallet_id     Int
  entry_type    EntryType
  ref_code      String?   @db.VarChar(40)
  amount        Decimal   @db.Decimal(18, 2)
  direction     Direction
  balance_after Decimal?  @db.Decimal(18, 2)
  occurred_at   DateTime  @default(now())
  note          String?   @db.VarChar(255)
  wallet        Wallet    @relation(fields: [wallet_id], references: [id])

  @@index([wallet_id, occurred_at])
  @@map("account_transaction")
}

/* ===== Ticket Purchases ===== */
model TicketPurchase {
  id           Int       @id @default(autoincrement())
  range_start  Int
  range_end    Int
  unit_price   Decimal   @db.Decimal(18, 2)
  total_price  Decimal   @db.Decimal(18, 2)
  status       TicketPurchaseStatus
  user_id      Int
  wallet_id    Int
  draw_id      Int?      // ← ตอนนี้เป็น optional

  purchased_at DateTime  @default(now())

  User   User   @relation(fields: [user_id], references: [id])
  Wallet Wallet @relation(fields: [wallet_id], references: [id])
  Draw   Draw?  @relation(fields: [draw_id], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([user_id])
  @@index([wallet_id])
  @@index([draw_id])
  @@map("ticket_purchases")
}
model Draw {
  id           Int          @id @default(autoincrement())
  draw_code    String       @unique @db.VarChar(32)
  product_name String?      @db.VarChar(128)
  status       DrawStatus
  created_at   DateTime     @default(now())
  results      DrawResult[]
  prizeTiers   PrizeTier[]

  @@map("draws")
  ticketPurchases TicketPurchase[]
}

model PrizeTier {
  id            Int          @id @default(autoincrement())
  draw_id       Int
  tier_name     String       @db.VarChar(64)
  prize_amount  Decimal      @db.Decimal(18, 2)
  winners_count Int
  DrawResult    DrawResult[]

  draw          Draw         @relation(fields: [draw_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("prize_tiers")
}

model DrawResult {
  id               Int       @id @default(autoincrement())
  draw_id          Int
  prize_tier_id    Int
  entry_id         Int?
  user_id          Int?
  purchase_item_id Int?
  ticket_number    String?   @db.VarChar(32)
  prize_amount     Decimal   @db.Decimal(18, 2)
  published_at     DateTime  @default(now())
  // ⬇️ ใส่ Cascade ที่นี่
  draw             Draw      @relation(fields: [draw_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  prizeTier        PrizeTier @relation(fields: [prize_tier_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([draw_id])
  @@index([prize_tier_id])
  @@map("draw_results")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
}

enum EntryType {
  DEPOSIT
  PURCHASE
  WITHDRAWAL
  REFUND
  PRIZE
}

enum Direction {
  CREDIT
  DEBIT
}

enum TicketPurchaseStatus {
  HELD
  OWNED
  CANCELED
}

enum DrawStatus {
  SCHEDULED
  LOCKED
  DRAWING
  PUBLISHED
  CLOSED
}
